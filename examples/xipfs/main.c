/*
 * Copyright (C) 2024 Universit√© de Lille
 *
 * This file is subject to the terms and conditions of the GNU Lesser
 * General Public License v2.1. See the file LICENSE in the top level
 * directory for more details.
 */

/**
 * @ingroup     examples
 * @{
 *
 * @file
 * @brief       An application demonstrating xipfs
 *
 * @author      Damien Amara <damien.amara@univ-lille.fr>
 * @author      Gregory Guche <gregory.guche@univ-lille.fr>
 *
 * @}
 */

#include <fcntl.h>
#include <stdlib.h>

#include "fs/xipfs_fs.h"
#include "periph/flashpage.h"
#include "shell.h"
#include "vfs.h"

/**
 * @def PANIC
 *
 * @brief This macro handles fatal errors
 */
#define PANIC() for (;;);

/**
 * @def NVME0P0_PAGE_NUM
 *
 * @brief The number of flash page for the nvme0p0 file system
 */
#define NVME0P0_PAGE_NUM 10

/**
 * @def NVME0P1_PAGE_NUM
 *
 * @brief The number of flash page for the nvme0p1 file system
 */
#define NVME0P1_PAGE_NUM 15

/*
 * Allocate a new contiguous space for the nvme0p0 file system
 */
XIPFS_NEW_PARTITION(nvme0p0, "/dev/nvme0p0", NVME0P0_PAGE_NUM);

/*
 * Allocate a new contiguous space for the nvme0p1 file system
 */
XIPFS_NEW_PARTITION(nvme0p1, "/dev/nvme0p1", NVME0P1_PAGE_NUM);


const unsigned char hello_world_bin[896] = {
    0x2d,0xe9,0x80,0x48,0x1,0x68,0x75,0x4a,0x43,0x68,0x8d,0xb0,0x0,0x93,0x5,0x90,
    0x83,0x68,0x88,0x18,0x1,0x90,0x40,0x68,0x4,0x90,0x1,0x98,0x8a,0x58,0x0,0x69,
    0x2,0x90,0x1,0x98,0x80,0x68,0x3,0x90,0x1,0x98,0xc0,0x68,0x7,0x90,0x1,0x98,
    0x84,0x69,0x1c,0x30,0x0,0xeb,0x84,0x0,0x8,0x90,0x8,0x9c,0x8,0x99,0x4,0x98,
    0xa,0x44,0x20,0x44,0xa,0x90,0x42,0xf0,0x1,0x2,0x2,0x98,0xa,0x9c,0xb,0x92,
    0x0,0x9a,0x5,0x19,0x14,0x18,0x3,0x9a,0x22,0x44,0x9,0x92,0x9,0x99,0x7,0x9a,
    0xa3,0x42,0x2,0xeb,0x1,0x6,0x3,0xd3,0x8b,0x42,0x1,0xd3,0xb3,0x42,0x2,0xd2,
    0x0,0x20,0x0,0xf0,0xb7,0xf8,0x5,0x9b,0x59,0x4a,0x5e,0x60,0xdb,0x68,0x13,0x44,
    0x1,0x9a,0x52,0x69,0x13,0x44,0x5,0x9a,0x23,0xf0,0x1f,0x3,0xd3,0x60,0x3,0x9b,
    0x21,0x46,0x28,0x46,0x6,0x93,0x6,0x9b,0x2f,0x2b,0x28,0xd8,0x1c,0x46,0x7,0x2c,
    0x2c,0xd8,0x6,0x9b,0x6,0x9c,0xdb,0x8,0x6f,0xf0,0x7,0x2,0x2,0xfb,0x3,0x43,
    0x3,0x2b,0x4,0xd9,0x50,0xf8,0x4,0x2b,0x41,0xf8,0x4,0x2b,0x4,0x3b,0x1b,0xbb,
    0x1a,0x46,0x7,0x99,0x99,0x42,0x25,0xd8,0x0,0x24,0x2,0x9b,0xa3,0x42,0x25,0xd8,
    0x1,0x9b,0x0,0x25,0x3,0xf1,0x18,0x6,0x1,0x9b,0x9b,0x69,0xab,0x42,0x3e,0xd8,
    0x5,0x9b,0x0,0x9a,0xb,0x9c,0x18,0x46,0x92,0x46,0x20,0x47,0xfe,0xe7,0xb0,0xe8,
    0xfc,0x5f,0xa1,0xe8,0xfc,0x5f,0x6,0x9b,0x30,0x3b,0xcb,0xe7,0xf0,0xe8,0x2,0x23,
    0xe1,0xe8,0x2,0x23,0x8,0x3c,0xca,0xe7,0x10,0xf8,0x1,0x2b,0x1,0xf8,0x1,0x2b,
    0x1,0x3b,0xd4,0xe7,0x9,0x99,0xca,0x50,0x4,0x33,0xd2,0xe7,0xa,0x9b,0x4,0x9a,
    0x1b,0x59,0x9a,0x42,0x5,0xd9,0x8,0x9a,0x13,0x44,0x0,0x9a,0x13,0x51,0x4,0x34,
    0xcb,0xe7,0x4,0x9a,0x9b,0x1a,0x2,0x9a,0x9a,0x42,0x1,0xd9,0x0,0x9a,0xf3,0xe7,
    0x2,0x9a,0x3,0x99,0x9a,0x1a,0x91,0x42,0xf8,0xd8,0x3,0x99,0x52,0x1a,0x7,0x99,
    0x91,0x42,0xf3,0xd8,0x1,0x20,0x0,0xf0,0x45,0xf8,0x0,0x23,0xe5,0xe7,0x56,0xf8,
    0x4,0x4f,0x4,0x9a,0x8,0x9b,0xa2,0x42,0x1b,0x59,0x33,0xd8,0xa4,0x1a,0x2,0x9a,
    0xa2,0x42,0x31,0xd8,0x3,0x99,0xa2,0x1a,0x91,0x42,0x9,0xd9,0x0,0x9a,0x14,0x44,
    0x4,0x9a,0x9a,0x42,0xb,0xd9,0x8,0x9a,0x13,0x44,0x23,0x60,0x1,0x35,0xa3,0xe7,
    0x3,0x99,0x52,0x1a,0x7,0x99,0x91,0x42,0xf0,0xd8,0x0,0x24,0xf,0xe0,0x4,0x9a,
    0x9b,0x1a,0x2,0x9a,0x9a,0x42,0x10,0xd8,0x3,0x99,0x9a,0x1a,0x91,0x42,0x1,0xd9,
    0x0,0x9a,0xe9,0xe7,0x3,0x99,0x52,0x1a,0x7,0x99,0x91,0x42,0xf8,0xd8,0x1,0x20,
    0x0,0xf0,0x10,0xf8,0x2,0x20,0x0,0xf0,0xd,0xf8,0x3,0x20,0x0,0xf0,0xa,0xf8,
    0x0,0x23,0xda,0xe7,0x0,0x24,0xf5,0xe7,0x0,0x24,0xf6,0xe7,0x94,0x2,0x0,0x0,
    0xcf,0x2,0x0,0x0,0x2,0x46,0x4f,0xf0,0x4,0x0,0xf,0xf2,0x36,0x1,0xab,0xbe,
    0x4f,0xf0,0x4,0x0,0xf,0xf2,0xa,0x3,0x3,0xeb,0xc2,0x2,0x42,0xf0,0x1,0x2,
    0x10,0x47,0xf,0xf2,0x25,0x1,0x0,0xf0,0xa,0xb8,0xf,0xf2,0x2d,0x1,0x0,0xf0,
    0x6,0xb8,0xf,0xf2,0x3b,0x1,0x0,0xf0,0x2,0xb8,0xf,0xf2,0x54,0x1,0xab,0xbe,
    0xfe,0xe7,0x63,0x72,0x74,0x30,0x3a,0x20,0x0,0x6e,0x6f,0x74,0x20,0x65,0x6e,0x6f,
    0x75,0x67,0x68,0x20,0x72,0x61,0x6d,0xa,0x0,0x6f,0x75,0x74,0x2d,0x6f,0x66,0x2d,
    0x62,0x6f,0x75,0x6e,0x64,0x73,0x20,0x6f,0x66,0x66,0x73,0x65,0x74,0xa,0x0,0x63,
    0x61,0x6e,0x6e,0x6f,0x74,0x20,0x72,0x65,0x6c,0x6f,0x63,0x61,0x74,0x65,0x20,0x6f,
    0x66,0x66,0x73,0x65,0x74,0x73,0x20,0x69,0x6e,0x20,0x2e,0x72,0x6f,0x6d,0xa,0x0,
    0x63,0x61,0x6e,0x6e,0x6f,0x74,0x20,0x72,0x65,0x6c,0x6f,0x63,0x61,0x74,0x65,0x20,
    0x6f,0x66,0x66,0x73,0x65,0x74,0x73,0x20,0x69,0x6e,0x20,0x2e,0x67,0x6f,0x74,0xa,
    0x0,0x0,0x0,0x0,0x6d,0x0,0x0,0x0,0xa4,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x4,0x0,0x0,0x0,0x18,0x0,0x0,0x0,0xbc,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x70,0xb5,0xa,0x4b,0x5,0x46,0x5a,0xf8,0x3,0x0,0xe,0x46,0x0,0xf0,0x1a,0xf8,
    0x1,0x24,0xac,0x42,0x1,0xdb,0x0,0x20,0x70,0xbd,0x5,0x4b,0x56,0xf8,0x24,0x10,
    0x5a,0xf8,0x3,0x0,0x0,0xf0,0xe,0xf8,0x1,0x34,0xf2,0xe7,0x0,0x0,0x0,0x0,
    0x4,0x0,0x0,0x0,0x2,0x4b,0x5a,0xf8,0x3,0x30,0x1b,0x68,0x1b,0x68,0x18,0x47,
    0x8,0x0,0x0,0x0,0xf,0xb4,0x7,0xb5,0x7,0x4b,0x5a,0xf8,0x3,0x30,0x4,0xa9,
    0x1b,0x68,0x51,0xf8,0x4,0xb,0x5b,0x68,0x1,0x91,0x98,0x47,0x3,0xb0,0x5d,0xf8,
    0x4,0xeb,0x4,0xb0,0x70,0x47,0x0,0xbf,0x8,0x0,0x0,0x0,0x8,0xb5,0x7,0x4b,
    0x5a,0xf8,0x3,0x30,0x0,0xf5,0xa3,0x62,0x0,0xf5,0x83,0x61,0xd0,0xf8,0x14,0x4,
    0x1a,0x60,0xff,0xf7,0xbd,0xff,0xff,0xf7,0xd5,0xff,0xfe,0xe7,0x8,0x0,0x0,0x0,
    0x48,0x65,0x6c,0x6c,0x6f,0x20,0x57,0x6f,0x72,0x6c,0x64,0x21,0xa,0x0,0x25,0x73,
    0xa,0x0,0x0,0x0,0x90,0x0,0x0,0x0,0x9e,0x0,0x0,0x0,0xbc,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
};

#define FILENAME_OF_HELLO_WORLD_BIN  "/dev/nvme0p0/hello-world.bin"
#define SIZEOF_HELLO_WORLD_BIN       (sizeof(hello_world_bin) / sizeof(hello_world_bin[0]))

int execution_handler(int argc, char **argv) {

    (void)argc;
    (void)argv;



    int file_handle = vfs_open(FILENAME_OF_HELLO_WORLD_BIN, O_RDONLY, 0);
    if (file_handle < 0) {

        /** There's no executable file yet, let's drop one */
        int ret = xipfs_extended_driver_new_file(
            FILENAME_OF_HELLO_WORLD_BIN, SIZEOF_HELLO_WORLD_BIN, 1
        );
        if (ret < 0) {
            printf("xipfs_extended_driver_new_file : failed to create '%s' : error=%d\n",
                   FILENAME_OF_HELLO_WORLD_BIN, ret);
            return EXIT_FAILURE;
        }

        /** Fill it with blob data
         * Take care : vfs does not support O_APPEND with vfs_write, only O_WRONLY or O_RDWR
         */
        file_handle = vfs_open(FILENAME_OF_HELLO_WORLD_BIN, O_WRONLY, 0);
        if (file_handle < 0) {
            printf("vfs_open : failed to open '%s' : error =%d\n",
                   FILENAME_OF_HELLO_WORLD_BIN, file_handle);
            return EXIT_FAILURE;
        }

        ssize_t write_ret = vfs_write(file_handle, hello_world_bin, SIZEOF_HELLO_WORLD_BIN);
        if (write_ret < 0) {
            printf("vfs_write : failed to fill '%s' : error=%d\n",
                   FILENAME_OF_HELLO_WORLD_BIN, write_ret);
            vfs_close(file_handle);
            return EXIT_FAILURE;
        }
    }

    vfs_close(file_handle);

    char *exec_argv[] = {
        FILENAME_OF_HELLO_WORLD_BIN,
        NULL
    };
    int ret = xipfs_extended_driver_execv(FILENAME_OF_HELLO_WORLD_BIN, exec_argv);
    if (ret < 0) {
        printf("Failed to execute '%s' : error=%d\n", FILENAME_OF_HELLO_WORLD_BIN, ret);
        return EXIT_FAILURE;
    }

    return EXIT_SUCCESS;
}

static shell_command_t shell_commands[] = {
    {"exec", "Execute Hello World", execution_handler},
    {NULL, NULL, NULL},
};


/**
 * @internal
 *
 * @brief Mount a partition, or if it is corrupted, format and
 * remount it
 *
 * @param xipfs_mp A pointer to a memory region containing an
 * xipfs mount point structure
 */

static void mount_or_format(vfs_xipfs_mount_t *xipfs_mp)
{
    if (vfs_mount(&xipfs_mp->vfs_mp) < 0) {
        printf("vfs_mount: \"%s\": file system has not been "
            "initialized or is corrupted\n", xipfs_mp->vfs_mp.mount_point);
        printf("vfs_format: \"%s\": try initializing it\n",
            xipfs_mp->vfs_mp.mount_point);
        vfs_format(&xipfs_mp->vfs_mp);
        printf("vfs_format: \"%s\": OK\n", xipfs_mp->vfs_mp.mount_point);
        if (vfs_mount(&xipfs_mp->vfs_mp) < 0) {
            printf("vfs_mount: \"%s\": file system is corrupted!\n",
                xipfs_mp->vfs_mp.mount_point);
            PANIC();
        }
    }
    printf("vfs_mount: \"%s\": OK\n", xipfs_mp->vfs_mp.mount_point);
}


int main(void)
{
    char line_buf[SHELL_DEFAULT_BUFSIZE];

    mount_or_format(&nvme0p0);
    mount_or_format(&nvme0p1);

    shell_run(shell_commands, line_buf, SHELL_DEFAULT_BUFSIZE);

    return 0;
}
