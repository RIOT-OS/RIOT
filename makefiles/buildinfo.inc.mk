# This Makefile provides dynamically generated header files with constants
# about the current build. All these headers are intentionally small and
# focused to improve ccache's cache efficiency: The intended is to allow
# common code that does not depend on board name / CPU model / application name
# to be compiled only once for the target architecture and subsequently be
# served from ccache.

BUILDINFO_DIR := $(BINDIR)/riotbuild/buildinfo

.PHONY: create-buildinfo-dir
create-buildinfo-dir:
	mkdir -p "$(BUILDINFO_DIR)"

# buildinfo/riotver.h
# ===================
ifneq (,$(RIOT_VERSION_EXTRA))
  RIOT_VERSION_EXTRA_DEFINE := '#define CONFIG_RIOT_VERSION_EXTRA "$(RIOT_VERSION_EXTRA)"'
endif

$(BUILDINFO_DIR)/riotver.h: create-buildinfo-dir
	$(Q)echo '#pragma once' > $@
	$(Q)echo '/* autogenerated by makefiles/buildinfo.inc.mk */' >> $@
	$(Q)echo '#define RIOT_VERSION "$(RIOT_VERSION)"' >> $@
	$(Q)echo '#define RIOT_VERSION_CODE "$(RIOT_VERSION_CODE)"' >> $@
	$(Q)echo $(RIOT_VERSION_EXTRA_DEFINE) >> $@

BUILDDEPS += $(BUILDINFO_DIR)/riotver.h

# buildinfo/board.h
# =================
BOARDDEF := $(call uppercase_and_underscore,$(BOARD))

$(BUILDINFO_DIR)/board.h: create-buildinfo-dir
	$(Q)echo '#pragma once' > $@
	$(Q)echo '/* autogenerated by makefiles/buildinfo.inc.mk */' >> $@
	$(Q)echo '#define BOARD_$(BOARDDEF) "$(BOARD)"' >> $@
	$(Q)echo '#define RIOT_BOARD BOARD_$(BOARDDEF)' >> $@

BUILDDEPS += $(BUILDINFO_DIR)/board.h

# buildinfo/cpu.h
# ===============
CPUDEF := $(call uppercase_and_underscore,$(CPU))

$(BUILDINFO_DIR)/cpu.h: create-buildinfo-dir
	$(Q)echo '#pragma once' > $@
	$(Q)echo '/* autogenerated by makefiles/buildinfo.inc.mk */' >> $@
	$(Q)echo '#define CPU_$(CPUDEF) "$(CPU)"' >> $@
	$(Q)echo '#define RIOT_CPU CPU_$(CPUDEF)' >> $@

BUILDDEPS += $(BUILDINFO_DIR)/cpu.h

# buildinfo/app.h
# ===============

$(BUILDINFO_DIR)/app.h: create-buildinfo-dir
	$(Q)echo '#pragma once' > $@
	$(Q)echo '/* autogenerated by makefiles/buildinfo.inc.mk */' >> $@
	$(Q)echo '#define RIOT_APPLICATION "$(APPLICATION)"' >> $@

BUILDDEPS += $(BUILDINFO_DIR)/app.h
